<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–≥–æ–¥–Ω–æ–µ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- –í–û–ó–î–£–®–ù–´–ô –°–¢–ò–õ–¨ –ò –§–û–ù --- */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω: –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –Ω–µ–±–∞ + —Ä–∞–¥–∏–∞–ª—å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è "—Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ –±–ª–∏–∫–∞" —Å–≤–µ—Ä—Ö—É */
            background: 
                radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.5) 0%, transparent 60%),
                linear-gradient(180deg, #89f7fe 0%, #66a6ff 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
            position: relative;
        }

        /* --- –î–ï–ö–û–†: –û–ë–õ–ê–ö–ê --- */
        .clouds-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* –ß—Ç–æ–±—ã –¥–µ–∫–æ—Ä –Ω–µ –º–µ—à–∞–ª –∫–ª–∏–∫–∞–º */
            z-index: 1;
        }
        
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            filter: blur(8px); /* –†–∞–∑–º—ã—Ç–∏–µ –¥–ª—è –º—è–≥–∫–æ—Å—Ç–∏ */
            animation: floatCloud linear infinite;
        }

        /* –í–∞—Ä–∏–∞—Ü–∏–∏ –æ–±–ª–∞–∫–æ–≤ */
        .c1 { width: 120px; height: 100px; top: 15%; left: -15%; animation-duration: 35s; opacity: 0.8; }
        .c2 { width: 180px; height: 140px; top: 45%; left: -20%; animation-duration: 55s; animation-delay: -10s; opacity: 0.6; }
        .c3 { width: 90px; height: 80px; bottom: 20%; left: -10%; animation-duration: 28s; animation-delay: -5s; opacity: 0.9; }
        .c4 { width: 150px; height: 110px; top: 30%; right: -15%; animation-duration: 45s; animation-direction: reverse; opacity: 0.5; }
        .c5 { width: 70px; height: 60px; bottom: 10%; right: -5%; animation-duration: 30s; animation-direction: reverse; animation-delay: -15s; opacity: 0.7; }

        @keyframes floatCloud {
            from { transform: translateX(0); }
            to { transform: translateX(120vw); } /* –ü–ª—ã–≤—É—Ç —á–µ—Ä–µ–∑ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        }

        /* --- –î–ï–ö–û–†: –í–û–ó–î–£–®–ù–´–ï –®–ê–†–´ --- */
        .balloons-container {
            position: absolute;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .balloon {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: floatUp linear infinite, gentleBob 3s ease-in-out infinite alternate;
        }

        /* –ö—É–ø–æ–ª —à–∞—Ä–∞ */
        .envelope {
            width: 60px;
            height: 75px;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; /* –§–æ—Ä–º–∞ –∫–∞–ø–ª–∏/—è–π—Ü–∞ */
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        /* –ö–æ—Ä–∑–∏–Ω–∞ */
        .basket {
            width: 16px;
            height: 12px;
            background: #8d6e63;
            border-radius: 3px;
            margin-top: 2px;
            position: relative;
        }
        /* –í–µ—Ä–µ–≤–∫–∏ (–ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç—ã) */
        .basket::before, .basket::after {
            content: ''; position: absolute; top: -5px; width: 1px; height: 5px; background: #5d4037;
        }
        .basket::before { left: 2px; }
        .basket::after { right: 2px; }

        /* –í–∞—Ä–∏–∞—Ü–∏–∏ —à–∞—Ä–æ–≤ */
        .b1 { 
            left: 15%; bottom: -100px; 
            animation-duration: 40s; 
        }
        .b1 .envelope { background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); }

        .b2 { 
            right: 20%; bottom: -150px; scale: 0.7; opacity: 0.8;
            animation-duration: 55s; animation-delay: -20s;
        }
        .b2 .envelope { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }

        .b3 { 
            left: 55%; bottom: -80px; scale: 0.5; opacity: 0.6;
            animation-duration: 65s; animation-delay: -5s;
        }
        .b3 .envelope { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }


        @keyframes floatUp {
            to { transform: translateY(-130vh) translateX(20vw); } /* –í–≤–µ—Ä—Ö –∏ –Ω–µ–º–Ω–æ–≥–æ –≤–±–æ–∫ */
        }
        @keyframes gentleBob {
            from { margin-top: 0; }
            to { margin-top: 8px; } /* –õ–µ–≥–∫–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ */
        }


        /* --- –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° --- */
        #app-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px); /* –£—Å–∏–ª–∏–ª–∏ –±–ª—é—Ä */
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
            z-index: 10; /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–≤–µ—Ä—Ö –¥–µ–∫–æ—Ä–∞ */
            transition: all 0.5s ease;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        h1, h2, p { margin: 0 0 20px 0; color: #445; }
        h1 { font-size: 2.5rem; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            padding: 15px 35px;
            color: white;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(79, 172, 254, 0.5);
        }

        button:active {
            transform: translateY(1px);
            box-shadow: 0 5px 10px rgba(79, 172, 254, 0.3);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            80% { transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-pop { animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        .hidden { display: none; }

        /* –ö–∞—Ä—Ç–∞ */
        #map-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; /* –ö–∞—Ä—Ç–∞ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            background: white;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #map { flex-grow: 1; width: 100%; }

        #close-map {
            position: absolute; top: 20px; right: 20px; z-index: 1001;
            background: linear-gradient(90deg, #ff758c 0%, #ff7eb3 100%);
            padding: 10px 25px; font-size: 1rem; box-shadow: 0 5px 15px rgba(255, 117, 140, 0.4);
        }
        #close-map:hover { box-shadow: 0 8px 20px rgba(255, 117, 140, 0.6); }

        /* Popup –∫–∞—Ä—Ç—ã */
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.98);
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 5px;
        }
        .custom-popup .leaflet-popup-tip { background: rgba(255, 255, 255, 0.98); }
        .popup-emoji { font-size: 3.5rem; display: block; margin-bottom: 10px; text-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .popup-temp { font-weight: 800; font-size: 1.4rem; color: #333; margin-bottom: 5px; }
        .popup-text { font-size: 0.95rem; color: #666; }
    </style>
</head>
<body>

    <div class="clouds-container">
        <div class="cloud c1"></div>
        <div class="cloud c2"></div>
        <div class="cloud c3"></div>
        <div class="cloud c4"></div>
        <div class="cloud c5"></div>
    </div>

    <div class="balloons-container">
        <div class="balloon b1">
            <div class="envelope"></div>
            <div class="basket"></div>
        </div>
        <div class="balloon b2">
            <div class="envelope"></div>
            <div class="basket"></div>
        </div>
        <div class="balloon b3">
            <div class="envelope"></div>
            <div class="basket"></div>
        </div>
    </div>
    <div id="app-container">
        <div id="step-1">
            <h1>–ü—Ä–∏–≤–µ—Ç! üå§Ô∏è</h1>
            
            <button onclick="checkWeather()">–ö–∞–∫ —Ç–∞–º –ø–æ–≥–æ–¥–∞?</button>
        </div>

        <div id="step-2" class="hidden">
            <h2 id="status-title">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–µ–±–æ...</h2>
            <p id="funny-message" style="font-size: 1.2rem; min-height: 75px; display: flex; align-items: center; justify-content: center;">...</p>
            <button id="btn-explore" class="hidden" onclick="showMap()">–ü–æ—Å–º–æ—Ç—Ä–∏–º üåç</button>
        </div>
    </div>

    <div id="map-container">
        <button id="close-map" onclick="closeMap()">–ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</button>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const API_KEY = '–í–ê–®_API_–ö–õ–Æ–ß_–ó–î–ï–°–¨'; // <--- –ù–ï –ó–ê–ë–£–î–¨–¢–ï –í–°–¢–ê–í–ò–¢–¨ –ö–õ–Æ–ß

        const container = document.getElementById('app-container');
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const funnyMsg = document.getElementById('funny-message');
        const statusTitle = document.getElementById('status-title');
        const btnExplore = document.getElementById('btn-explore');
        let map;

        // --- –õ–û–ì–ò–ö–ê ---

        function checkWeather() {
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            funnyMsg.innerHTML = "<i>–°–º–æ—Ç—Ä—é –Ω–∞ –æ–±–ª–∞–∫–∞...</i> üßê";

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(successGeo, errorGeo);
            } else {
                handleWeatherResult(20, 'Clouds');
            }
        }

        function successGeo(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            fetchWeatherData(lat, lon, true);
        }

        function errorGeo() {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ë—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ —É –≤–∞—Å –û–±–ª–∞—á–Ω–æ.");
            handleWeatherResult(15, 'Clouds');
        }

        async function fetchWeatherData(lat, lon, isLocalUser = false) {
            if (API_KEY === '–í–ê–®_API_–ö–õ–Æ–ß_–ó–î–ï–°–¨' || API_KEY === '') {
                console.warn("API –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–∏—Ç–∞—Ü–∏—é.");
                const conditions = ['Clear', 'Rain', 'Snow', 'Clouds'];
                const rndCond = conditions[Math.floor(Math.random() * conditions.length)];
                const rndTemp = Math.floor(Math.random() * 35) - 5;
                
                // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å–µ—Ç–∏
                setTimeout(() => {
                    if (isLocalUser) {
                        handleWeatherResult(rndTemp, rndCond);
                    }
                }, 1000);

                if (!isLocalUser) return { temp: rndTemp, main: rndCond };
                return;
            }

            try {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=ru&appid=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (isLocalUser) {
                    handleWeatherResult(data.main.temp, data.weather[0].main);
                } else {
                    return { temp: data.main.temp, main: data.weather[0].main };
                }
            } catch (error) {
                console.error(error);
                if(isLocalUser) handleWeatherResult(15, 'Clouds');
            }
        }

        function handleWeatherResult(temp, condition) {
            let message = "";
            let title = "";

            if (temp < 0) {
                title = "–ë—Ä—Ä—Ä! ‚ùÑÔ∏è";
                message = "–ï—Å—Ç—å –æ–¥–∏–Ω –º–∏–Ω—É—Å... –ù–∞ —É–ª–∏—Ü–µ –º–∏–Ω—É—Å. –ü–æ—Å–º–æ—Ç—Ä–∏–º, –∫–æ–º—É –¥–æ—Å—Ç–∞–ª–æ—Å—å –ª–µ—Ç–æ?";
            } else {
                switch (condition) {
                    case 'Clear':
                        title = "–°–æ–ª–Ω–µ—á–Ω–æ! ‚òÄÔ∏è";
                        message = "–°–æ–ª–Ω–µ—á–Ω–æ –∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ. –ó–∞–≥–ª—è–Ω–µ–º, –∫–æ–º—É —Å–µ–≥–æ–¥–Ω—è —Ç–∞–∫ –Ω–µ –ø–æ–≤–µ–∑–ª–æ?";
                        break;
                    case 'Rain':
                    case 'Drizzle':
                    case 'Thunderstorm':
                        title = "–ú–æ–∫—Ä–æ... üåßÔ∏è";
                        message = "–¢—ã –ø–æ–¥ –¥–æ–∂–¥—ë–º, –Ω–æ, –≤–æ–∑–º–æ–∂–Ω–æ, –∫—Ç–æ-—Ç–æ —â—É—Ä–∏—Ç—Å—è –æ—Ç —Å–æ–ª–Ω—Ü–∞?";
                        break;
                    case 'Snow':
                        title = "–°–Ω–µ–∂–Ω–æ! üå®Ô∏è";
                        message = "–ó–∞—Ç–µ—Ä—è–ª—Å—è –ø–æ–¥ —Å—É–≥—Ä–æ–±–∞–º–∏? –ê —É –∫–æ–≥–æ-—Ç–æ —Å–µ–π—á–∞—Å —Ü–≤–µ—Ç—É—Ç –¥–µ—Ä–µ–≤—å—è...";
                        break;
                    case 'Clouds':
                    default:
                        title = "–ü–∞—Å–º—É—Ä–Ω–æ ‚òÅÔ∏è";
                        message = "–û–±–ª–∞–∫–∞ –ø–µ—Ä–µ–∫—Ä—ã–ª–∏ –≤—Å—ë —Å—á–∞—Å—Ç—å–µ? –£–∑–Ω–∞–π —É –∫–æ–≥–æ –µ–≥–æ –±—É–¥–µ–º –æ—Ç–±–∏—Ä–∞—Ç—å!";
                        break;
                }
            }

            statusTitle.textContent = title;
            funnyMsg.textContent = message;
            
            btnExplore.classList.remove('hidden');
            btnExplore.classList.add('animate-pop');
        }

        // --- –õ–û–ì–ò–ö–ê –ö–ê–†–¢–´ ---

        function showMap() {
            document.getElementById('map-container').style.display = 'flex';
            initMap();
        }

        function closeMap() {
            document.getElementById('map-container').style.display = 'none';
        }

        function initMap() {
            if (map) {
                map.invalidateSize(); 
                return;
            }

            map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap, &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            map.on('click', async function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;

                const popup = L.popup({ className: 'custom-popup' })
                    .setLatLng(e.latlng)
                    .setContent('<div style="text-align:center; padding: 10px;">–£–∑–Ω–∞–µ–º –ø–æ–≥–æ–¥—É... ü§î<br><small>–°–µ–∫—É–Ω–¥–æ—á–∫—É</small></div>')
                    .openOn(map);

                const weather = await fetchWeatherData(lat, lon);
                
                let emoji = "üå°Ô∏è";
                let text = "";

                if (weather.temp > 30 && weather.main === 'Clear') {
                    emoji = "ü•µ‚òÄÔ∏è"; text = "–ê–¥—Å–∫–∞—è –∂–∞—Ä–∞!";
                } else if (weather.temp > 20 && weather.main === 'Clear') {
                    emoji = "üòéüåû"; text = "–ö–∞–π—Ñ, —Ç–µ–ø–ª–æ!";
                } else if (weather.main === 'Clear') {
                    emoji = "‚òÄÔ∏èüòä"; text = "–Ø—Å–Ω–æ –∏ —Å–≤–µ–∂–æ.";
                } else if (weather.main.includes('Rain') || weather.main.includes('Drizzle')) {
                    emoji = "‚òîüåßÔ∏è"; text = "–ó–æ–Ω—Ç–∏–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.";
                } else if (weather.main.includes('Thunder')) {
                    emoji = "‚õàÔ∏è‚ö°"; text = "–°–≤–µ—Ä–∫–∞–µ—Ç! –°–∏–¥–∏ –¥–æ–º–∞.";
                } else if (weather.main === 'Snow') {
                    emoji = "‚òÉÔ∏è‚ùÑÔ∏è"; text = "–í—Ä–µ–º—è –ª–µ–ø–∏—Ç—å —Å–Ω–µ–∂–∫–∏!";
                } else if (weather.main === 'Clouds') {
                    emoji = "‚òÅÔ∏èüòê"; text = "–°–∫—É—á–Ω–∞—è —Å–µ—Ä–æ—Å—Ç—å.";
                } else if (weather.main === 'Mist' || weather.main === 'Fog') {
                    emoji = "üå´Ô∏èü¶î"; text = "–Å–∂–∏–∫ –≤ —Ç—É–º–∞–Ω–µ.";
                } else {
                    emoji = "üåÄü§î"; text = "–ß—Ç–æ-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ.";
                }

                const content = `
                    <div>
                        <span class="popup-emoji">${emoji}</span>
                        <div class="popup-temp">${Math.round(weather.temp)}¬∞C</div>
                        <div class="popup-text">${text}</div>
                    </div>
                `;

                popup.setContent(content);
            });
        }
    </script>
</body>
</html>
